\chapter{Конструкторская часть}

В данном разделе описаны требования к программному обеспечению, а также рассмотрены структуры данных, алгоритмы и математические уравнения, выбранные для построения сцены.

\section{Требования к программному обеспечению}

Программа должна обеспечивать следующую функциональность:
\begin{itemize}[label*=---]
    \item изменение положения камеры и её направления;
    \item изменение характеристик волны;
    \item изменение характеристик капли;
    \item выбор алгоритма закраски;
    \item возможность отрисовки полигонов модели.
\end{itemize}

\section{Описание структур данных}

Сцена представляет собой массив моделей, объект камеры и объект источника освещения.  
Структуры данных для этих объектов следующие.

\begin{enumerate}
	\item Модель включает в себя следующие данные:
	\begin{itemize}
		\item массив вершин фигуры;
		\item массив полигонов фигуры;
		\item массив векторов нормалей к вершинам;
		\item цвет поверхности;
		\item матрица аффинных преобразований.
	\end{itemize}
	\item Камера содержит:
	\begin{itemize}
		\item положение в пространстве;
		\item значения углов тангажа и рыскания;
		\item направление взгляда и ориентацию верха.
	\end{itemize}
	\item Источник освещения характеризуется вектором распространения лучей света или его положением в пространстве.
\end{enumerate}


\section{Aлгоритм построения изображения}

Алгоритм генерации изображения представлен в виде диаграммы, оформленной в соответствии с нотацией IDEF0 и отражающей общую декомпозицию алгоритма см.рис.8--11. 

\img{115mm}{im_01_A0}{Функциональная схема алгоритма построения изображения, декомпозиция верхнего уровня}
\newpage

\img{115mm}{im_02_A0}{Функциональная схема алгоритма построения изображения, декомпозиция уровня A0}
\newpage

\img{115mm}{im_03_A1}{Функциональная схема алгоритма построения изображения, декомпозиция уровня A1}
\newpage

\img{115mm}{im_04_A3}{Функциональная схема алгоритма построения изображения, декомпозиция уровня A3}
\newpage

\section{Приведение к пространству камеры}

Для перемещения по сцене используется камера, которая определяется точкой положения в пространстве и собственной системой координат, состоящей из трех ортогональных векторов.

Обозначим:
\begin{itemize}
	\item Point (P) --- положение камеры;
	\item forward (F) --- вектор взгляда;
	\item Up (U) --- вектор вверх;
	\item Right (R) --- вектор вправо.
\end{itemize}

Для перехода в пространство камеры выполняются два этапа, описанных ниже.

\begin{enumerate}
	\item Перенос полигона в отрицательную стороны от камеры на расстояние Point с помощью матрицы переноса~\cite{palcing-camera}:
	\begin{equation}
		\begin{pmatrix}
			1  & 0  & 0  & 0 \\
			0  & 1  & 0  & 0 \\
			0  & 0  & 1  & 0 \\
			-Px & -Py & -Pz & 1
		\end{pmatrix}
	\end{equation}
	\item Преобразование полигона к системе координат камеры при помощи матрицы поворота~\cite{palcing-camera}:
	\begin{equation}
		\begin{pmatrix}
			Rx  & Ux  & Fx  & 0 \\
			Ry  & Uy  & Fy  & 0 \\
			Rz  & Uz  & Fz  & 0 \\
			0   & 0   & 0   & 1
		\end{pmatrix}
	\end{equation}
\end{enumerate}

Управление камеры производится с помощью изменения углом Эйлера.
Обозначим $\alpha$ --- угол поворота вокруг оси ОУ (тангаж) и  $\beta$ --- угол поворота вокруг оси OX (рыскание).
Тогда координаты вектора направления камеры можно вычислить по следующим формулам:
\begin{equation}
	F_x = cos(\alpha) \cdot cos(\beta)
\end{equation}
\begin{equation}
	F_y = sin(\alpha)
\end{equation}
\begin{equation}
	F_z = cos(\alpha) \cdot sin(\beta)
\end{equation}

\section{Невидимые грани}

Для оптимизации процесса построения изображения можно значительно сократить временные затраты, отбрасывая нелицевые грани моделей. Это позволяет избежать растеризации невидимых полигонов.  

Для определения видимости грани используется следующая формула:

\begin{equation}
	(\overrightarrow{N}, \overrightarrow{V}) = \begin{cases}
		 \geq 0,~\text{если грань невидима} \\
		 < 0,~\text{если грань видима}
	\end{cases},
\end{equation}
где $\overrightarrow{N}$ --- вектор внешней нормали к грани модели, $\overrightarrow{V}$ --- вектор от камеры до любой точки грани.

\section{Алгоритм, использующий Z-буфер}

Для растеризации треугольного полигона необходимо вычислить глубину каждой его точки.  
Затем нужно провести сравнение значения глубины точки с глубиной, хранящейся в Z-буфере.  
Если глубина пикселя меньше, это означает, что пиксель находится ближе к камере и должен быть растеризован.  
В этом случае значение глубины пикселя записывается в Z-буфер, а его интенсивность вычисляется и заносится в буфер кадра.  

Полная схема алгоритма Z-буфера представлена на рисунке~\ref{img:schem_z_buffer}.


\img{160mm}{schem_z_buffer }{Схема алгоритма, использующего Z-буфер}

\newpage

\section{Описание уравнения бегущей волны}
Бегущие волны моделируются свободными гармоническими колебаниями. 
Для перехода в нормализированное пространство, в котором значение функции лежит в пределах от 0 до 1, 
выполняется преобразование:

\begin{equation}
    f(x) = \dfrac{\sin{x} + 1}{2}
\end{equation}

С целью получения реалистичного изображения волн необходимо принять во внимание тот факт, 
что волны могут иметь большую крутизну и остроту пиков.

\begin{equation}
    f(x) = \dfrac{\sin{x} + 1}{2}
\end{equation}

Необходимо также учитывать направление волны. Ее моделирование происходит в двумерном поле высот, 
поэтому требуется определять движение волн в обоих направлениях. Вектор направления должен быть 
параллельным плоскости невозмущенной поверхности жидкости, т. е. иметь координату z, равную нулю ~\cite{WAVE}.

\begin{equation}
    S = Dir(x,y)\cdot Pos(x,y)
\end{equation}

\begin{flushleft}
    где $Dir(x, y)$ — вектор направления волны, $Pos(x, y)$ — вектор координат точки.
\end{flushleft}

% где $Dir(x, y)$ — вектор направления волны, $Pos(x, y)$ — вектор координат точки.

Учет частоты происходит в формуле в соответствии с известным соотношением определения частоты $f$:

\begin{equation}
    f = \dfrac{2\pi}{\lambda}
\end{equation}
\begin{flushleft}
где $\lambda$ — длина волны.
\end{flushleft}
Тогда получим:
\begin{equation}
    S = Dir(x,y)\cdot Pos(x,y)f
\end{equation}

Для учета скорости волны необходимо определить фазовую постоянную в соответствии с выражением~\cite{WAVE}.
\begin{equation}
    \psi = vf = \dfrac{2v\pi}{\lambda}
\end{equation}

Окончательное выражение для вычисления координаты точки $z$ на поверхности жидкости 
в зависимости от ее координат $x$, $y$ и времени имеет следующий вид:
\begin{equation}
    f(x,y,t) = A\left(\dfrac{\sin{S} + 1}{2}\right)^k
\end{equation}

\begin{flushleft}
где $S = Dir(x, y)\cdot Pos(x, y)f + t\psi$
\end{flushleft}

\section{Описание круговых волн}
Учесть этот эффект можно с помощью переопределения вектора направления в каждой точке поверхности 
и изменения координаты точки смещением начала координат в точку центра круговой волны~\cite{WAVE}.

\begin{equation}
        D(x,y) = \left(\dfrac{(x, y) - C}{|(x, y) - C|}\right),
\end{equation}
\begin{flushleft}
где $C$ --- точка начала распространения круговой волны; 
$X$, $Y$ --- координаты рассматриваемой точки.
\end{flushleft}

Измененные значения подставляются в формулу бегущей волны.

\section{Описание вычисления нормалей}

Используя уравнения поверхностей, определим нормали в любой ее точке. 
Уравнение нормали к поверхности в точке $(x, y, z)$:

\begin{equation}
    N(x,y,z) = NB(x,y,z)\otimes NT(x,y,z)
\end{equation}
\begin{flushleft}
где $NB(x, y, z)$ и $NT(x, y, z)$ --- частные производные по x и y;    
\end{flushleft}

\begin{align}
    NB(x, y, z) = \dfrac{\partial f(x,y,t)}{\partial x} \\
    NT(x, y, z) = \dfrac{\partial f(x,y,t)}{\partial y}
\end{align}
\begin{flushleft}
где $f(x, y, t)$ --- итоговое уравнение поверхности;    
\end{flushleft}


\begin{align}
    \dfrac{\partial f(x,y,t)}{\partial x} = 0.5Dir_x f A\left(\dfrac{\sin{S} + 1}{2}\right)^{k-1}\cos{S}, \\
    \dfrac{\partial f(x,y,t)}{\partial y} = 0.5Dir_y f A\left(\dfrac{\sin{S} + 1}{2}\right)^{k-1}\cos{S}.
\end{align}


Задавая векторы нормалей проекциями на координатные оси, получим~\cite{WAVE}:

\begin{align}
    NB(x, y, z) &= \left(\dfrac{\partial x}{\partial x}, \dfrac{\partial y}{\partial x}, \dfrac{\partial f(x,y,t)}{\partial x}\right) = \left(1, 0, \dfrac{\partial f(x,y,t)}{\partial x}\right), \\
    NT(x, y, z) &= \left(\dfrac{\partial x}{\partial y}, \dfrac{\partial y}{\partial y}, \dfrac{\partial f(x,y,t)}{\partial y}\right) = \left(0, 1, \dfrac{\partial f(x,y,t)}{\partial y}\right).
\end{align}

\section*{Вывод}
В данном разделе были представлены требования к программному обеспечению, рассмотрены структуры данных, алгоритмы и математические уравнения, выбранные для построения сцены.
